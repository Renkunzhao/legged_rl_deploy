# =============================================================================
# AUTO-GENERATED config.yaml for G1 Mimic (whole_body_tracking)
# Generated from ONNX metadata + training pipeline source code
# Env: Tracking-Flat-G1-Wo-State-Estimation-v0 (G1FlatWoStateEstimationEnvCfg)
# =============================================================================
#
# ⚠️  IMPORTANT: The training pipeline uses a NON-URDF joint ordering!
#     IsaacLab resolves joint_names_expr regex across actuator groups,
#     producing a "training order" that interleaves left/right/waist.
#     All arrays below follow this training order (29 joints):
#
#     TrainIdx  Joint Name                   HW(URDF) Idx
#     --------  ---------------------------  ----------
#      0        left_hip_pitch_joint          0
#      1        right_hip_pitch_joint         6
#      2        waist_yaw_joint              12
#      3        left_hip_roll_joint           1
#      4        right_hip_roll_joint          7
#      5        waist_roll_joint             13
#      6        left_hip_yaw_joint            2
#      7        right_hip_yaw_joint           8
#      8        waist_pitch_joint            14
#      9        left_knee_joint               3
#     10        right_knee_joint              9
#     11        left_shoulder_pitch_joint    15
#     12        right_shoulder_pitch_joint   22
#     13        left_ankle_pitch_joint        4
#     14        right_ankle_pitch_joint      10
#     15        left_shoulder_roll_joint     16
#     16        right_shoulder_roll_joint    23
#     17        left_ankle_roll_joint         5
#     18        right_ankle_roll_joint       11
#     19        left_shoulder_yaw_joint      17
#     20        right_shoulder_yaw_joint     24
#     21        left_elbow_joint             18
#     22        right_elbow_joint            25
#     23        left_wrist_roll_joint        19
#     24        right_wrist_roll_joint       26
#     25        left_wrist_pitch_joint       20
#     26        right_wrist_pitch_joint      27
#     27        left_wrist_yaw_joint         21
#     28        right_wrist_yaw_joint        28
#
# =============================================================================

# lowlevel controller
llc_config_file: src/unitree_lowlevel/config/g1.yaml

# [SOURCE] tracking_env_cfg.py: sim.dt=0.005, decimation=4 → policy_dt=0.02
ll_dt: 0.005

# whole_body_tracking
policy:
  backend: ort
  model_path: src/legged_rl_deploy/policies/g1/mimic/pose/policy.onnx
  # [SOURCE] ONNX: input shape=[1,154], output shape=[1,29]
  input_dim: 154
  output_dim: 29
  policy_dt: 0.02

  # ---------------------------------------------------------------------------
  # joint_ids_map: maps training-internal index → URDF/hardware index
  # deploy reads: state.joint_pos()[ joint_ids_map[i] ] to fill training slot i
  # [SOURCE] Computed from ONNX metadata joint_names vs URDF joint ordering
  # ---------------------------------------------------------------------------
  joint_ids_map: [0, 6, 12,  1, 7, 13,  2, 8, 14,  3, 9,
                  15, 22,  4, 10,  16, 23,  5, 11,
                  17, 24,  18, 25,  19, 26,  20, 27,  21, 28]

  # [SOURCE] ONNX metadata: joint_stiffness (training order)
  stiffness: [40.179, 40.179, 40.179,  99.098, 99.098, 28.501,  40.179, 40.179, 28.501,  99.098, 99.098,
              14.251, 14.251,  28.501, 28.501,  14.251, 14.251,  28.501, 28.501,
              14.251, 14.251,  14.251, 14.251,  14.251, 14.251,  16.778, 16.778, 16.778, 16.778]

  # [SOURCE] ONNX metadata: joint_damping (training order)
  damping:   [ 2.558,  2.558,  2.558,   6.309,  6.309,  1.814,   2.558,  2.558,  1.814,   6.309,  6.309,
               0.907,  0.907,   1.814,  1.814,   0.907,  0.907,   1.814,  1.814,
               0.907,  0.907,   0.907,  0.907,   0.907,  0.907,   1.068,  1.068,  1.068,  1.068]

  # No gamepad commands for mimic task
  commands: {}

  # ---------------------------------------------------------------------------
  # motions: reference motion data
  # [SOURCE] commands.py → MotionCommand → MotionLoader reads .npz
  # npz keys: joint_pos, joint_vel, body_pos_w, body_quat_w, fps, ...
  # [CHECK] Verify the correct .npz file path for your deployment
  # ---------------------------------------------------------------------------
  motions:
    fps: 50
    file: src/legged_rl_deploy/policies/g1/mimic/pose/motion.csv

  # ---------------------------------------------------------------------------
  # actions: post-processing of raw network output
  # [SOURCE] isaaclab/.../joint_actions.py: target = raw * scale + offset
  #          where offset = default_joint_pos (use_default_offset=True)
  # [SOURCE] processor.h: process_order [scale, offset] → x = x*scale + offset
  # All values from ONNX metadata (training order)
  # ---------------------------------------------------------------------------
  actions:
    JointPositionAction:
      process_order: [scale, offset]
      # [SOURCE] ONNX metadata: action_scale = 0.25 * effort / stiffness
      scale:  [ 0.548,  0.548,  0.548,   0.351,  0.351,  0.439,   0.548,  0.548,  0.439,   0.351,  0.351,
                0.439,  0.439,   0.439,  0.439,   0.439,  0.439,   0.439,  0.439,
                0.439,  0.439,   0.439,  0.439,   0.439,  0.439,   0.075,  0.075,  0.075,  0.075]
      # [SOURCE] ONNX metadata: default_joint_pos (= action offset)
      offset: [-0.312, -0.312,  0.000,   0.000,  0.000,  0.000,   0.000,  0.000,  0.000,   0.669,  0.669,
                0.200,  0.200,  -0.363, -0.363,   0.200, -0.200,   0.000,  0.000,
                0.000,  0.000,   0.600,  0.600,   0.000,  0.000,   0.000,  0.000,  0.000,  0.000]

  # ---------------------------------------------------------------------------
  # observations: assembled by PolicySlot::assembleObsFrame()
  # [SOURCE] ONNX metadata: observation_names =
  #   command(58), motion_anchor_ori_b(6), base_ang_vel(3),
  #   joint_pos(29), joint_vel(29), actions(29)
  # Total: 58 + 6 + 3 + 29 + 29 + 29 = 154
  #
  # NOTE: G1FlatWoStateEstimationEnvCfg removes:
  #   - motion_anchor_pos_b (set to None in flat_env_cfg.py)
  #   - base_lin_vel        (set to None in flat_env_cfg.py)
  # ---------------------------------------------------------------------------
  observations:
    stack:
      length: 1
      order: newest_first
    terms:
      # ── motion_command (dim=58) ──
      # [SOURCE] commands.py: MotionCommand.command = cat(joint_pos[t], joint_vel[t])
      #          = 29 joint_pos + 29 joint_vel from reference motion at current phase
      # ONNX metadata name: "command"  →  deploy C++ term: "motion_command"
      motion_command:

      # ── motion_anchor_ori_b (dim=6) ──
      # [SOURCE] observations.py: subtract_frame_transforms(robot_torso, motion_torso)
      #          → quat → matrix_from_quat[:,:2].reshape(-1) → 6D rotation repr
      # Deploy: getTorsoQuatFromImuAndWaist (IMU on pelvis + waist joints)
      #         then q_motion_inv * q_robot → rot_mat.transpose().leftCols(2).flatten
      # [VERIFIED] Deploy matches training (transpose compensates inverted quat order)
      motion_anchor_ori_b:

      # ── base_ang_vel_B (dim=3) ──
      # [SOURCE] isaaclab mdp: base_ang_vel() = root angular velocity in body frame
      # Deploy: IMU gyroscope reading (body frame)
      base_ang_vel_B:

      # ── joint_pos (dim=29) ──
      # [SOURCE] isaaclab mdp: joint_pos_rel() = joint_pos - default_joint_pos
      # Deploy: raw_joint_pos + offset, where offset = -default_joint_pos
      joint_pos:
        process_order: [offset]
        # Negated default_joint_pos (training order)
        offset: [ 0.312,  0.312,  0.000,   0.000,  0.000,  0.000,   0.000,  0.000,  0.000,  -0.669, -0.669,
                 -0.200, -0.200,   0.363,  0.363,  -0.200,  0.200,   0.000,  0.000,
                  0.000,  0.000,  -0.600, -0.600,   0.000,  0.000,   0.000,  0.000,  0.000,  0.000]

      # ── joint_vel (dim=29) ──
      # [SOURCE] isaaclab mdp: joint_vel_rel() = joint_vel - default_vel (default=0)
      # No processing needed
      joint_vel:

      # ── last_action (dim=29) ──
      # [SOURCE] isaaclab mdp: last_action() = raw network output (before scale+offset)
      # Deploy: cached from previous policy inference
      last_action:
