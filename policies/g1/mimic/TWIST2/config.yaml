# =============================================================================
# Deploy config for G1 TWIST2 (legged_rl_deploy)
# Aligned with: TWIST2/deploy_real/server_low_level_g1_sim.py
# =============================================================================

# lowlevel controller
llc_config_file: src/unitree_lowlevel/config/g1.yaml
ll_dt: 0.001

# Match torque clipping limits used in server_low_level_g1_sim.py
tau_max: [
  100, 100, 100, 150, 40, 40,
  100, 100, 100, 150, 40, 40,
  150, 150, 150,
  40, 40, 40, 40, 4.0, 4.0, 4.0,
  40, 40, 40, 40, 4.0, 4.0, 4.0
]

# true => deploy computes final torque from q_target/kp/kd (then lowlevel torqueClip applies tau_max)
clip_final_tau: true

policy:
  backend: ort
  model_path: src/legged_rl_deploy/policies/g1/mimic/TWIST2/twist2_1017_20k.onnx
  input_dim: 1432
  output_dim: 29
  policy_dt: 0.01

  # training-index -> hardware-index
  joint_ids_map: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28]

  stiffness: [
    100, 100, 100, 150, 40, 40,
    100, 100, 100, 150, 40, 40,
    150, 150, 150,
    40, 40, 40, 40, 4.0, 4.0, 4.0,
    40, 40, 40, 40, 4.0, 4.0, 4.0
  ]

  damping: [
    2, 2, 2, 4, 2, 2,
    2, 2, 2, 4, 2, 2,
    4, 4, 4,
    5, 5, 5, 5, 0.2, 0.2, 0.2,
    5, 5, 5, 5, 0.2, 0.2, 0.2
  ]

  commands: {}

  # raw_action -> clip[-10,10] -> *0.5 -> +default_dof_pos
  actions:
    JointPositionAction:
      process_order: [clip, scale, offset]
      min: -10.0
      max: 10.0
      scale: 0.5
      offset: [
        -0.2, 0.0, 0.0, 0.4, -0.2, 0.0,
        -0.2, 0.0, 0.0, 0.4, -0.2, 0.0,
        0.0, 0.0, 0.0,
        0.0, 0.4, 0.0, 1.2, 0.0, 0.0, 0.0,
        0.0, -0.4, 0.0, 1.2, 0.0, 0.0, 0.0
      ]

  observations:
    # layout is used; stack is kept as a harmless placeholder
    stack:
      length: 1
      order: newest_first
    # Match python history deque prefilled with zeros
    history_warmup: zero
    terms:
      # action_mimic from redis key "action_body_unitree_g1_with_hands" (35 dim)
      mimic:
        params:
          source: redis
          dim: 35
          redis:
            host: 127.0.0.1
            port: 6379
            db: 0
            key: action_body_unitree_g1_with_hands
            timeout_ms: 5
            fallback: hold_last
            motion_start_trigger: "R2 + X"

      # ang_vel * 0.25
      base_ang_vel_B:
        process_order: [scale]
        scale: 0.25

      # rpy[:2]
      roll_pitch:

      # dof_pos - default_dof_pos
      joint_pos:
        process_order: [offset]
        offset: [
          0.2, 0.0, 0.0, -0.4, 0.2, 0.0,
          0.2, 0.0, 0.0, -0.4, 0.2, 0.0,
          0.0, 0.0, 0.0,
          0.0, -0.4, 0.0, -1.2, 0.0, 0.0, 0.0,
          0.0, 0.4, 0.0, -1.2, 0.0, 0.0, 0.0
        ]

      # dof_vel with ankle indices [4,5,10,11] zeroed, then *0.05
      joint_vel:
        process_order: [scale]
        scale: [
          0.05, 0.05, 0.05, 0.05, 0.0, 0.0,
          0.05, 0.05, 0.05, 0.05, 0.0, 0.0,
          0.05, 0.05, 0.05,
          0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05,
          0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05
        ]

      # previous raw action
      last_action:

    # obs_buf = [obs_full, obs_hist(10), future_obs=mimic]
    # obs_full = [mimic, base_ang_vel_B, roll_pitch, joint_pos, joint_vel, last_action]
    layout:
      blocks:
        - kind: current_frame
        - kind: history_frame
          length: 10
          order: oldest_first
          include_current: false
        - kind: current_terms
          terms: [mimic]
